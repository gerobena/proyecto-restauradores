name: Retail ETL mensual

on:
  schedule:
    # Día 2 de cada mes a las 04:00 UTC (ajusta si quieres otra hora o día)
    - cron: "0 4 2 * *"
  workflow_dispatch: {}  # permite ejecutarlo manualmente desde Actions

jobs:
  etl:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install system deps (LibreOffice + rclone)
        run: |
          sudo apt-get update
          sudo apt-get install -y libreoffice rclone

      - name: Restore rclone config from secret (Base64)
        run: |
          mkdir -p ~/.config/rclone
          echo "$RCLONE_CONF_B64" | base64 -d > ~/.config/rclone/rclone.conf
          chmod 600 ~/.config/rclone/rclone.conf
        env:
          RCLONE_CONF_B64: ${{ secrets.RCLONE_CONF_B64 }}

      - name: Sanity check rclone remote
        run: |
          rclone --version
          echo "Listing root of onedrive to verify auth..."
          rclone ls onedrive: --max-depth 1 | head -n 20 || true

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Sync OneDrive -> data/raw
        run: |
          mkdir -p data/raw
          rclone copy onedrive:Restauradores_Ingesta_Reportes data/raw \
            --include "ventas_*.xls" \
            --include "ventas_*.xlsx" \
            --include "compras_*.xls" \
            --include "compras_*.xlsx" \
            --include "inventario_*.xls" \
            --include "inventario_*.xlsx" \
            --create-empty-src-dirs --stats 5s
          echo "Contenido descargado en data/raw:"
          ls -lah data/raw

      - name: Run notebook with Papermill (produce data/summary.parquet)
        run: |
          papermill notebooks/analisis.ipynb notebooks/analisis_output.ipynb \
            -p RAW_DIR data/raw \
            -p OUTPUT_PARQUET data/summary.parquet

      - name: Check summary exists
        run: |
          test -f data/summary.parquet && ls -lh data/summary.parquet

      - name: Commit & push updated summary
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: actualizar summary.parquet"
          file_pattern: data/summary.parquet
